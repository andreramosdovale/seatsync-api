# SeatSync API

[![Java 21](https://img.shields.io/badge/Java-21-blue.svg)](https://www.oracle.com/java/technologies/javase/21-GAA.html)
[![Spring Boot](https://img.shields.io/badge/Spring_Boot-3.3.x-brightgreen.svg)](https://spring.io/projects/spring-boot)
[![Kotlin](https://img.shields.io/badge/Kotlin-1.9.x-blueviolet.svg)](https://kotlinlang.org)

A modern, high-performance backend API for a cinema seat reservation system. This project is architected following the principles of **Clean
Architecture** and **Domain-Driven Design (DDD)**, featuring a secure RBAC model and built on a cutting-edge Kotlin & Java 21 (Virtual Threads) stack.

This is a personal study project to implement a robust, scalable, and testable domain-focused backend system.

## Project & Architecture Context

This repository contains the backend API. The project architecture strictly isolates business logic from frameworks. All core business rules, the
complete architectural pattern (Clean/DDD layer definitions), database schema, and the full, detailed **API specification for every endpoint** are
documented in the following file:

**Please see: [TECHNICAL\_BRIEF.md](TECHNICAL_BRIEF.md)**

---

## Technology Stack

This project uses a modern, production-grade stack:

* **Core:** Kotlin, Java 21 (LTS), Spring Boot 3.x
* **Key Feature:** Configured to use **Virtual Threads (Project Loom)** for massive I/O scalability.
* **Persistence:** PostgreSQL (run via Docker), Spring Data JPA, and **Flyway** (for migrations).
* **Security:** Spring Security 6 with a stateless **JWT + Refresh Token** flow. JWT handling is managed via the official **`OAuth2 Resource Server`**
  starter.
* **Architecture:** Clean Architecture + DDD (Domain/Application/Infrastructure layers).
* **Testing:** **Testcontainers** for high-fidelity integration tests against a real, temporary Postgres container.
* **Build:** Gradle (with Kotlin DSL - `build.gradle.kts`).
* **API Docs:** Springdoc OpenAPI (for auto-generated Swagger UI).
* **Monitoring:** Spring Boot Actuator.

---

## Getting Started (Installation Guide)

Follow these instructions to get the API running locally.

### Prerequisites

* **JDK 21** (or newer)
* **Docker Desktop** (or Docker Engine + Docker Compose)
* Git

### 1. Clone the Repository

```bash
git clone https://github.com/andreramosdovale/seatsync-api.git
cd seatsync-api
````

### 2\. Start the Database

This project uses Docker Compose to run the PostgreSQL database.

```bash
docker-compose up -d
```

This will start a PostgreSQL container on `localhost:5432` matching the credentials needed by the application.

### 3\. Configure the Application

This project runs on the `default` Spring profile. All configuration goes directly into the main properties file.

1. Navigate to `src/main/resources/`.

2. Edit the file: **`application.properties`**.

3. Paste the following configuration (and **replace the JWT secret**):

    ```properties
    # Database Connection (matches docker-compose.yml)
    # NOTE: The database name is 'seatsync_db'
    spring.datasource.url=jdbc:postgresql://localhost:5432/seatsync_db
    spring.datasource.username=youruser
    spring.datasource.password=yourpass

    # Flyway will find the DB and automatically run all pending migrations on startup.
    spring.flyway.baseline-on-migrate=true

    # The magic switch! Tell Spring Boot to use Java 21's Virtual Threads for every web request.
    spring.threads.virtual.enabled=true
    ```

### 4\. Run the Application

Now that the database is running and the configuration is set, run the application using the Gradle wrapper:

```bash
./gradlew bootRun
```

The API will start on `http://localhost:8080`.

You can access the **interactive API documentation (Swagger UI)** generated by Springdoc at:
**[http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)**

-----

## API Endpoint Summary

This is a high-level overview of the main API routes and their required authorization. For the complete specification (payloads, error codes, etc.),
see `TECHNICAL_BRIEF.md`.

### Public Endpoints (No Auth Required)

| Verb   | Route                                       | Description                                              |
|:-------|:--------------------------------------------|:---------------------------------------------------------|
| `POST` | `/auth/register`                            | Register a new user (defaults to `ROLE_CUSTOMER`).       |
| `POST` | `/auth/login`                               | Login (receive Access + Refresh tokens).                 |
| `POST` | `/auth/refresh`                             | Generate a new Access Token using a valid Refresh Token. |
| `GET`  | `/api/movies`                               | Get a paginated list of all available movies.            |
| `GET`  | `/api/movies/{movieId}/sessions`            | Get paginated sessions for a specific movie.             |
| `GET`  | `/api/sessions/{sessionId}/layout-cadeiras` | Get the full seat layout for a session.                  |

### Customer Endpoints (Requires `ROLE_CUSTOMER`)

| Verb   | Route              | Description                                    |
|:-------|:-------------------|:-----------------------------------------------|
| `POST` | `/api/reservas`    | Book a seat for a specific session.            |
| `GET`  | `/api/me/reservas` | View the authenticated user's booking history. |

### Staff Endpoints (Requires `ROLE_STAFF`)

| Verb   | Route                | Description                       |
|:-------|:---------------------|:----------------------------------|
| `POST` | `/api/staff/filmes`  | Add a new movie to the catalog.   |
| `POST` | `/api/staff/salas`   | Add a new screening room.         |
| `POST` | `/api/staff/sessoes` | Create a new session for a movie. |

### Admin Endpoints (Requires `ROLE_ADMIN`)

| Verb  | Route                               | Description                           |
|:------|:------------------------------------|:--------------------------------------|
| `GET` | `/api/admin/usuarios`               | List all user accounts in the system. |
| `PUT` | `/api/admin/usuarios/{userId}/role` | Assign/change a user's role.          |
